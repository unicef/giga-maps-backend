FROM python:3.8-buster

# Install dependencies
RUN apt-get update
RUN apt-get install -y --no-install-recommends \
    build-essential \
    libcurl4-openssl-dev \
    libjpeg-dev \
    vim \
    ntp \
    libpq-dev
RUN apt-get install -y --no-install-recommends \
    git-core
RUN apt-get install -y --no-install-recommends \
    postgresql-client \
    libpq-dev \
    python-psycopg2
RUN apt-get install -y --no-install-recommends \
    python-gdal \
    gdal-bin \
    libgdal-dev \
    libgdal20 \
    libxml2-dev \
    libxslt-dev \
    xmlsec1

RUN pip install --upgrade \
    setuptools \
    pip \
    wheel \
    pipenv

RUN apt-get update && apt-get install -y \
    postgresql postgresql-contrib libpq-dev gcc 
    #systemctl start postgresql.service

RUN service postgresql start && \
    su - postgres -c "psql -c \"ALTER USER postgres WITH PASSWORD 'root';\""

#USER postgres
#RUN psql -c "ALTER USER postgres WITH PASSWORD 'root';"
    
#USER root
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - \
    echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" | tee /etc/apt/sources.list.d/pgdg.list \
    curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg \
    echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/redis.list \
    apt update \
    apt install postgis postgresql-14-postgis-3 \
    apt-get install redis \
    apt install binutils libproj-dev gdal-bin

# python app
ENV PYTHONUNBUFFERED 1
ENV PYTHONPATH /code

RUN mkdir /code

ADD Pipfile /code/Pipfile
ADD Pipfile.lock /code/Pipfile.lock

WORKDIR /code/

ARG AD_B2C_BASE_URL
ENV AD_B2C_BASE_URL=$AD_B2C_BASE_URL
ARG AD_B2C_CLIENT_ID
ENV AD_B2C_CLIENT_ID=$AD_B2C_CLIENT_ID
ARG AD_B2C_DOMAIN
ENV AD_B2C_DOMAIN=$AD_B2C_DOMAIN
ARG AD_B2C_EDIT_PROFILE_POLICY
ENV AD_B2C_EDIT_PROFILE_POLICY=$AD_B2C_EDIT_PROFILE_POLICY
ARG AD_B2C_FORGOT_PASSWORD_POLICY
ENV AD_B2C_FORGOT_PASSWORD_POLICY=$AD_B2C_FORGOT_PASSWORD_POLICY
ARG AD_B2C_SIGNUP_SIGNIN_POLICY
ENV AD_B2C_SIGNUP_SIGNIN_POLICY=$AD_B2C_SIGNUP_SIGNIN_POLICY
ARG AD_B2C_TENANT_ID
ENV AD_B2C_TENANT_ID=$AD_B2C_TENANT_ID
ARG CELERY_BROKER_URL
ENV CELERY_BROKER_URL=$CELERY_BROKER_URL
ARG CELERY_RESULT_BACKEND_URL
ENV CELERY_RESULT_BACKEND_URL=$CELERY_RESULT_BACKEND_URL
ARG COUNTRY_INDEX_NAME
ENV COUNTRY_INDEX_NAME=$COUNTRY_INDEX_NAME
ARG DAILY_CHECK_APP_API_CODE
ENV DAILY_CHECK_APP_API_CODE=$DAILY_CHECK_APP_API_CODE
ARG DAILY_CHECK_APP_BASE_URL
ENV DAILY_CHECK_APP_BASE_URL=$DAILY_CHECK_APP_BASE_URL
ARG DATA_LAYER_DASHBOARD_URL
ENV DATA_LAYER_DASHBOARD_URL=$DATA_LAYER_DASHBOARD_URL
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
ARG DEFAULT_FROM_EMAIL
ENV DEFAULT_FROM_EMAIL=$DEFAULT_FROM_EMAIL
ARG DJANGO_SECRET_KEY
ENV DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY
ARG DJANGO_SETTINGS_MODULE
ENV DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
ARG DOCKER_REPOSITORY
ENV DOCKER_REPOSITORY=$DOCKER_REPOSITORY
ARG DOCKER_SERVICE_CONNECTION
ENV DOCKER_SERVICE_CONNECTION=$DOCKER_SERVICE_CONNECTION
ARG GIGA_METER_DATABASE_URL
ENV GIGA_METER_DATABASE_URL=$GIGA_METER_DATABASE_URL
ARG GIGA_METER_ENABLE_AUTO_SYNC
ENV GIGA_METER_ENABLE_AUTO_SYNC=$GIGA_METER_ENABLE_AUTO_SYNC
ARG MAILJET_API_KEY
ENV MAILJET_API_KEY=$MAILJET_API_KEY
ARG MAILJET_API_URL
ENV MAILJET_API_URL=$MAILJET_API_URL
ARG MAILJET_SECRET_KEY
ENV MAILJET_SECRET_KEY=$MAILJET_SECRET_KEY
ARG PROJECT_FULL_NAME
ENV PROJECT_FULL_NAME=$PROJECT_FULL_NAME
ARG PROJECT_SHORT_NAME
ENV PROJECT_SHORT_NAME=$PROJECT_SHORT_NAME
ARG QOS_BEARER_TOKEN
ENV QOS_BEARER_TOKEN=$QOS_BEARER_TOKEN
ARG QOS_ENDPOINT
ENV QOS_ENDPOINT=$QOS_ENDPOINT
ARG QOS_EXPIRATION_TIME
ENV QOS_EXPIRATION_TIME=$QOS_EXPIRATION_TIME
ARG QOS_SCHEMA_NAME
ENV QOS_SCHEMA_NAME=$QOS_SCHEMA_NAME
ARG QOS_SHARE_CREDENTIALS_VERSION
ENV QOS_SHARE_CREDENTIALS_VERSION=$QOS_SHARE_CREDENTIALS_VERSION
ARG QOS_SHARE_NAME
ENV QOS_SHARE_NAME=$QOS_SHARE_NAME
ARG READ_ONLY_DATABASE_URL
ENV READ_ONLY_DATABASE_URL=$READ_ONLY_DATABASE_URL
ARG REDIS_URL_DEV
ENV REDIS_URL_DEV=$REDIS_URL_DEV
ARG SCHOOL_INDEX_NAME
ENV SCHOOL_INDEX_NAME=$SCHOOL_INDEX_NAME
ARG SCHOOL_MASTER_BEARER_TOKEN
ENV SCHOOL_MASTER_BEARER_TOKEN=$SCHOOL_MASTER_BEARER_TOKEN
ARG SCHOOL_MASTER_DASHBOARD_URL
ENV SCHOOL_MASTER_DASHBOARD_URL=$SCHOOL_MASTER_DASHBOARD_URL
ARG SCHOOL_MASTER_ENDPOINT
ENV SCHOOL_MASTER_ENDPOINT=$SCHOOL_MASTER_ENDPOINT
ARG SCHOOL_MASTER_EXPIRATION_TIME
ENV SCHOOL_MASTER_EXPIRATION_TIME=$SCHOOL_MASTER_EXPIRATION_TIME
ARG SCHOOL_MASTER_REVIEW_GRACE_PERIOD_IN_HRS
ENV SCHOOL_MASTER_REVIEW_GRACE_PERIOD_IN_HRS=$SCHOOL_MASTER_REVIEW_GRACE_PERIOD_IN_HRS
ARG SCHOOL_MASTER_SCHEMA_NAME
ENV SCHOOL_MASTER_SCHEMA_NAME=$SCHOOL_MASTER_SCHEMA_NAME
ARG SCHOOL_MASTER_SHARE_CREDENTIALS_VERSION
ENV SCHOOL_MASTER_SHARE_CREDENTIALS_VERSION=$SCHOOL_MASTER_SHARE_CREDENTIALS_VERSION
ARG SCHOOL_MASTER_SHARE_NAME
ENV SCHOOL_MASTER_SHARE_NAME=$SCHOOL_MASTER_SHARE_NAME
ARG SEARCH_API_KEY
ENV SEARCH_API_KEY=$SEARCH_API_KEY
ARG SEARCH_ENDPOINT
ENV SEARCH_ENDPOINT=$SEARCH_ENDPOINT
ARG SONAR_HOST
ENV SONAR_HOST=$SONAR_HOST
ARG SONAR_TOKEN
ENV SONAR_TOKEN=$SONAR_TOKEN
ARG SSH_PASSWD
ENV SSH_PASSWD=$SSH_PASSWD
ARG SUPPORT_EMAIL_ID
ENV SUPPORT_EMAIL_ID=$SUPPORT_EMAIL_ID
ARG SUPPORT_PHONE_NUMBER
ENV SUPPORT_PHONE_NUMBER=$SUPPORT_PHONE_NUMBER              

 # todo: try to figure out how we can test using dev packages and exclude them from prod build at the same time...
RUN pipenv install --ignore-pipfile --dev

ADD . /code/

RUN ./scripts/runtests.sh




